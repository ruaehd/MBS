<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="V1_AdminRsvMgt">
	<select id="countAdminRsvTot" parameterType="V1_Reservation" resultType="int">
		SELECT COUNT(CASE WHEN rsv_code=#{rsv_code} THEN 1 END) AS cnt	FROM `reservation`
	</select>
	
	<select id="selectAdminRsvList" parameterType="V1_Reservation" resultType="V1_Reservation">
		UPDATE `reservation` SET rsv_code=2 WHERE rsv_day <![CDATA[<]]> NOW() AND rsv_no IN (SELECT * FROM(SELECT r.rsv_no FROM `reservation` as r) a);
		
		SELECT s.str_name, DATE_FORMAT(rc.rsv_day, '%Y-%m-%d') AS rsv_day, rc.rsv_code_chk, rc.rsv_no, rc.rsv_sub_id, rc.rsv_sub_name FROM `store` s
		INNER JOIN
			(SELECT r.rsv_day, r.rsv_code, c.rsv_code_chk, r.str_number, r.rsv_no, r.rsv_sub_id, r.rsv_sub_name FROM `reservation` r 
				INNER JOIN `rsv_code` c
				ON r.rsv_code = c.rsv_code
    			WHERE c.rsv_code=#{rsv_code}
			) rc
		ON s.str_number = rc.str_number
		ORDER BY rc.rsv_no DESC LIMIT #{page} , 10
	</select>

</mapper>